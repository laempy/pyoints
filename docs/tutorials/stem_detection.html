
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Detection of tree stems with Pyoints &#8212; Pyoints version 0.2.0rc1 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="ICP for point cloud alignment" href="icp.html" />
    <link rel="prev" title="Getting started" href="getting_started.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="icp.html" title="ICP for point cloud alignment"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="getting_started.html" title="Getting started"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Pyoints version 0.2.0rc1 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 4ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="section" id="Detection-of-tree-stems-with-Pyoints">
<h1>Detection of tree stems with Pyoints<a class="headerlink" href="#Detection-of-tree-stems-with-Pyoints" title="Permalink to this headline">¶</a></h1>
<p>In the following, we try to detect stems in a forest using a three dimensional point cloud generated by a terrestrial laser scanner. The basic steps are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.</span> <span class="n">Loading</span> <span class="n">of</span> <span class="n">the</span> <span class="n">point</span> <span class="n">cloud</span> <span class="n">data</span>
<span class="mf">2.</span> <span class="n">Calculation</span> <span class="n">of</span> <span class="n">the</span> <span class="n">height</span> <span class="n">above</span> <span class="n">ground</span>
<span class="mf">3.</span> <span class="n">Filtering</span> <span class="n">of</span> <span class="n">stem</span> <span class="n">points</span>
<span class="mf">4.</span> <span class="n">Identification</span> <span class="n">of</span> <span class="n">stem</span> <span class="n">clusters</span>
<span class="mf">5.</span> <span class="n">Fitting</span> <span class="n">of</span> <span class="n">stem</span> <span class="n">vectors</span>
</pre></div>
</div>
<p>We begin with loading the required modules.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">pyoints</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">storage</span><span class="p">,</span>
    <span class="n">Extent</span><span class="p">,</span>
    <span class="n">filters</span><span class="p">,</span>
    <span class="n">interpolate</span><span class="p">,</span>
    <span class="n">clustering</span><span class="p">,</span>
    <span class="n">classification</span><span class="p">,</span>
    <span class="n">vector</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">mpl_toolkits</span> <span class="k">import</span> <span class="n">mplot3d</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<div class="section" id="Loading-of-the-point-cloud-data">
<h2>Loading of the point cloud data<a class="headerlink" href="#Loading-of-the-point-cloud-data" title="Permalink to this headline">¶</a></h2>
<p>We load a three dimensional point cloud scanned in a forest.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">lasReader</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">LasReader</span><span class="p">(</span><span class="s1">&#39;forest.las&#39;</span><span class="p">)</span>
<span class="n">las</span> <span class="o">=</span> <span class="n">lasReader</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">las</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
482981
</pre></div></div>
</div>
<p>We receive a LasRecords instance representing the point cloud. We can treat it like a numpy record array with additional features. So, we inspect its properties first.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;shape:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">las</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;attributes:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">las</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">descr</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;projection:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">las</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">proj4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;transformation matrix:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">las</span><span class="o">.</span><span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;data:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">las</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
shape:
(482981,)
attributes:
[(&#39;intensity&#39;, &#39;|u1&#39;), (&#39;classification&#39;, &#39;|u1&#39;), (&#39;coords&#39;, &#39;&lt;f8&#39;, (3,))]
projection:
+proj=utm +zone=32 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs
transformation matrix:
[[ 1.00000000e+00  0.00000000e+00  0.00000000e+00  3.64187980e+05]
 [ 0.00000000e+00  1.00000000e+00  0.00000000e+00  5.50957771e+06]
 [ 0.00000000e+00  0.00000000e+00  1.00000000e+00 -1.58000000e+00]
 [ 0.00000000e+00  0.00000000e+00  0.00000000e+00  1.00000000e+00]]
data:
[(216, 2, [ 3.64188062e+05,  5.50957772e+06, -1.28810938e+00])
 (213, 2, [ 3.64187976e+05,  5.50957776e+06, -1.27100996e+00])
 (214, 2, [ 3.64188095e+05,  5.50957776e+06, -1.30598884e+00]) ...
 (171, 5, [ 3.64193543e+05,  5.50958151e+06,  1.97219206e+01])
 (160, 5, [ 3.64193519e+05,  5.50958148e+06,  1.97416807e+01])
 (168, 5, [ 3.64193506e+05,  5.50958148e+06,  1.97642104e+01])]
</pre></div></div>
</div>
</div>
<div class="section" id="Calculation-of-the-height-above-ground">
<h2>Calculation of the height above ground<a class="headerlink" href="#Calculation-of-the-height-above-ground" title="Permalink to this headline">¶</a></h2>
<p>The LAS file provides some altitude values. But, we are interested in the height above ground instead. So, we select points representing the ground first, to fit a Digital Elevation Model (DEM). Using the DEM we calculate the height above ground for each point.</p>
<p>We use a DEM filter with a resolution of 0.5m. The filter selects local minima and guarantees a horizontal point distance of at least 0.5m and an altitude change between neighbored points below 50 degree.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">grd_ids</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">dem_filter</span><span class="p">(</span><span class="n">las</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">max_angle</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">grd_ids</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[ 97192  91536  96140  39010  94076  16662  10183 104165  85384  86854
 102761  38482  83712 102151 116834 105635 101280 118048 124970  87311
 108306  40907 123517 114405  13055 112076  24044  36647  51692  12269
  37402 256997 252300 266541  44324 109408  25316 265679 256605  32073
  45612 258610 252564 255461  42903 187875  27079  20457   6038 268661
 122507 271648  31654 167342 275851 260214 262363 189776 183189 276683
   5855 262318 261194 182891 278869  28162 162688 191363 290879 309455
 277489 272069 285002 196335 287382 283646 174355 319378 290570 312708
 165914 170659 192385 308441 199039 179555 314480 298770 195052 200959
 194685 220857 317956 212307 312093 211194 201875 203803 300082]
</pre></div></div>
</div>
<p>We have received a list of point indices which is used to select the desired representative ground points. So, we update the classification field for these points and plot them.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">las</span><span class="o">.</span><span class="n">classification</span><span class="p">[</span><span class="n">grd_ids</span><span class="p">]</span> <span class="o">=</span> <span class="mi">22</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">las</span><span class="p">[</span><span class="n">las</span><span class="o">.</span><span class="n">classification</span> <span class="o">==</span> <span class="mi">22</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;X (m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Y (m)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_stem_detection_14_0.png" src="../_images/tutorials_stem_detection_14_0.png" />
</div>
</div>
<p>Now, we fit a DEM using a nearest neighbor interpolator.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">xy</span> <span class="o">=</span> <span class="n">las</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">grd_ids</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">las</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="n">grd_ids</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">dem</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">KnnInterpolator</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Finally, we calculate the height above ground and add a corresponding attribute to the point cloud.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">height</span> <span class="o">=</span> <span class="n">las</span><span class="o">.</span><span class="n">coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">dem</span><span class="p">(</span><span class="n">las</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
<span class="n">las</span> <span class="o">=</span> <span class="n">las</span><span class="o">.</span><span class="n">add_fields</span><span class="p">([(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)],</span> <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">height</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">las</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">descr</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[(&#39;intensity&#39;, &#39;|u1&#39;), (&#39;classification&#39;, &#39;|u1&#39;), (&#39;coords&#39;, &#39;&lt;f8&#39;, (3,)), (&#39;height&#39;, &#39;&lt;f8&#39;)]
</pre></div></div>
</div>
</div>
<div class="section" id="Filtering-of-stem-points">
<h2>Filtering of stem points<a class="headerlink" href="#Filtering-of-stem-points" title="Permalink to this headline">¶</a></h2>
<p>Now, we try to filter the points subsequently until only points associated with stems remain.</p>
<p>We will focus on points with height above ground greater 0.5m only.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">las</span><span class="o">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fids</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
251047
</pre></div></div>
</div>
<p>Due to the unnecessary high point density we filter the point cloud using a duplicate point filter. Only a subset of points with a point distance of at least 0.1m is kept.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">filter_gen</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">ball</span><span class="p">(</span><span class="n">las</span><span class="p">[</span><span class="n">fids</span><span class="p">]</span><span class="o">.</span><span class="n">indexKD</span><span class="p">(),</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">fids</span> <span class="o">=</span> <span class="n">fids</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">filter_gen</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fids</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
12950
</pre></div></div>
</div>
<p>Let’s take a look at the remaining point cloud. To receive a nice plot, we define the axis limits first.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">axes_lims</span> <span class="o">=</span> <span class="n">Extent</span><span class="p">([</span>
    <span class="n">las</span><span class="o">.</span><span class="n">extent</span><span class="p">()</span><span class="o">.</span><span class="n">center</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">las</span><span class="o">.</span><span class="n">extent</span><span class="p">()</span><span class="o">.</span><span class="n">ranges</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
    <span class="n">las</span><span class="o">.</span><span class="n">extent</span><span class="p">()</span><span class="o">.</span><span class="n">center</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">las</span><span class="o">.</span><span class="n">extent</span><span class="p">()</span><span class="o">.</span><span class="n">ranges</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Z (m)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot_trisurf</span><span class="p">(</span><span class="o">*</span><span class="n">las</span><span class="p">[</span><span class="n">las</span><span class="o">.</span><span class="n">classification</span> <span class="o">==</span> <span class="mi">22</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gist_earth&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">las</span><span class="p">[</span><span class="n">fids</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">las</span><span class="o">.</span><span class="n">height</span><span class="p">[</span><span class="n">fids</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_stem_detection_26_0.png" src="../_images/tutorials_stem_detection_26_0.png" />
</div>
</div>
<p>We can see four trees with linear stems. But, there are a lot of points associated with branches or leaves. We assign class 23 to the selected points for later visualization.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">las</span><span class="o">.</span><span class="n">classification</span><span class="p">[</span><span class="n">fids</span><span class="p">]</span> <span class="o">=</span> <span class="mi">23</span>
</pre></div>
</div>
</div>
<p>To reduce noise, we only keep points with a lot of neighbors.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">count</span> <span class="o">=</span> <span class="n">las</span><span class="p">[</span><span class="n">fids</span><span class="p">]</span><span class="o">.</span><span class="n">indexKD</span><span class="p">()</span><span class="o">.</span><span class="n">ball_count</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">fids</span> <span class="o">=</span> <span class="n">fids</span><span class="p">[</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fids</span><span class="p">))</span>
<span class="n">las</span><span class="o">.</span><span class="n">classification</span><span class="p">[</span><span class="n">fids</span><span class="p">]</span> <span class="o">=</span> <span class="mi">24</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
10132
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Z (m)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot_trisurf</span><span class="p">(</span><span class="o">*</span><span class="n">las</span><span class="p">[</span><span class="n">las</span><span class="o">.</span><span class="n">classification</span> <span class="o">==</span> <span class="mi">22</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gist_earth&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">las</span><span class="p">[</span><span class="n">las</span><span class="o">.</span><span class="n">classification</span> <span class="o">==</span> <span class="mi">23</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">las</span><span class="p">[</span><span class="n">las</span><span class="o">.</span><span class="n">classification</span> <span class="o">==</span> <span class="mi">24</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_stem_detection_31_0.png" src="../_images/tutorials_stem_detection_31_0.png" />
</div>
</div>
<p>That’s much better, but we are interested in the linear shape of the stems only. So, we filter with a radius of 1 m to remove similar points. This results in a point cloud with point distances of at least 1 m.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">filter_gen</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">ball</span><span class="p">(</span><span class="n">las</span><span class="p">[</span><span class="n">fids</span><span class="p">]</span><span class="o">.</span><span class="n">indexKD</span><span class="p">(),</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">fids</span> <span class="o">=</span> <span class="n">fids</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">filter_gen</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fids</span><span class="p">))</span>
<span class="n">las</span><span class="o">.</span><span class="n">classification</span><span class="p">[</span><span class="n">fids</span><span class="p">]</span> <span class="o">=</span> <span class="mi">25</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
193
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Z (m)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot_trisurf</span><span class="p">(</span><span class="o">*</span><span class="n">las</span><span class="p">[</span><span class="n">las</span><span class="o">.</span><span class="n">classification</span> <span class="o">==</span> <span class="mi">22</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gist_earth&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">las</span><span class="p">[</span><span class="n">las</span><span class="o">.</span><span class="n">classification</span> <span class="o">==</span> <span class="mi">25</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_stem_detection_34_0.png" src="../_images/tutorials_stem_detection_34_0.png" />
</div>
</div>
<p>For dense point clouds, the filtering technique would result in point distances in a range of 1m to 2m. Thus, we can assume that linear arranged points should have 2 to 3 neighboring points within a radius of 1.5 m.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">count</span> <span class="o">=</span> <span class="n">las</span><span class="p">[</span><span class="n">fids</span><span class="p">]</span><span class="o">.</span><span class="n">indexKD</span><span class="p">()</span><span class="o">.</span><span class="n">ball_count</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">fids</span> <span class="o">=</span> <span class="n">fids</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">((</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fids</span><span class="p">))</span>
<span class="n">las</span><span class="o">.</span><span class="n">classification</span><span class="p">[</span><span class="n">fids</span><span class="p">]</span> <span class="o">=</span> <span class="mi">26</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
88
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Z (m)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot_trisurf</span><span class="p">(</span><span class="o">*</span><span class="n">las</span><span class="p">[</span><span class="n">las</span><span class="o">.</span><span class="n">classification</span> <span class="o">==</span> <span class="mi">22</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gist_earth&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">las</span><span class="p">[</span><span class="n">las</span><span class="o">.</span><span class="n">classification</span> <span class="o">==</span> <span class="mi">25</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">las</span><span class="p">[</span><span class="n">las</span><span class="o">.</span><span class="n">classification</span> <span class="o">==</span> <span class="mi">26</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_stem_detection_37_0.png" src="../_images/tutorials_stem_detection_37_0.png" />
</div>
</div>
<p>After applying the filters the stems are clearly visible. Thus, we can proceed with the actual detection of the stems.</p>
</div>
<div class="section" id="Identification-of-stem-clusters">
<h2>Identification of stem clusters<a class="headerlink" href="#Identification-of-stem-clusters" title="Permalink to this headline">¶</a></h2>
<p>We can detect the stems easily by clustering the previously filtered points. For this purpose we apply the DBSCAN algorithm.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cluster_indices</span> <span class="o">=</span> <span class="n">clustering</span><span class="o">.</span><span class="n">dbscan</span><span class="p">(</span><span class="n">las</span><span class="p">[</span><span class="n">fids</span><span class="p">]</span><span class="o">.</span><span class="n">indexKD</span><span class="p">(),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;number of points:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cluster_indices</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cluster IDs:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cluster_indices</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
number of points:
88
cluster IDs:
[-1  0  1  2  3  4  5  6]
</pre></div></div>
</div>
<p>In the next step, we remove small clusters and unassigned points. In addition, we add an additional field, providing the tree ID.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cluster_dict</span> <span class="o">=</span> <span class="n">classification</span><span class="o">.</span><span class="n">classes_to_dict</span><span class="p">(</span><span class="n">cluster_indices</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="n">fids</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">cluster_indices</span> <span class="o">=</span> <span class="n">classification</span><span class="o">.</span><span class="n">dict_to_classes</span><span class="p">(</span><span class="n">cluster_dict</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">las</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tree IDs:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cluster_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;cluster_dict:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cluster_dict</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tree IDs:
dict_keys([2, 3, 5, 6])
cluster_dict:
{2: [371973, 371173, 369487, 368857, 366101, 365936, 160689, 159509, 156897, 155653, 152232, 148925, 147360, 144290, 142432, 139379, 137708, 133495, 131557, 90638], 3: [374660, 370651, 370361, 367940, 367297, 162020, 161457, 158619, 154987, 154022, 150829, 150016, 146010, 144831, 141239, 139771, 135805, 133929, 129305], 5: [335645, 77637, 76803, 74807, 73937, 71618, 69644, 69372, 67774, 65755, 63816, 62705, 60297, 59194, 56386, 54681, 19293], 6: [243995, 242571, 241219, 239584, 238103, 235757, 234354, 232652, 231017, 229229, 209774]}
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">las</span> <span class="o">=</span> <span class="n">las</span><span class="o">.</span><span class="n">add_fields</span><span class="p">([(</span><span class="s1">&#39;tree_id&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)])</span>
<span class="n">las</span><span class="o">.</span><span class="n">tree_id</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="k">for</span> <span class="n">tree_id</span> <span class="ow">in</span> <span class="n">cluster_dict</span><span class="p">:</span>
    <span class="n">las</span><span class="o">.</span><span class="n">tree_id</span><span class="p">[</span><span class="n">cluster_dict</span><span class="p">[</span><span class="n">tree_id</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tree_id</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Z (m)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">las</span><span class="p">[</span><span class="n">las</span><span class="o">.</span><span class="n">tree_id</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">las</span><span class="o">.</span><span class="n">tree_id</span><span class="p">[</span><span class="n">las</span><span class="o">.</span><span class="n">tree_id</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_stem_detection_44_0.png" src="../_images/tutorials_stem_detection_44_0.png" />
</div>
</div>
</div>
<div class="section" id="Fitting-of-stem-vectors">
<h2>Fitting of stem vectors<a class="headerlink" href="#Fitting-of-stem-vectors" title="Permalink to this headline">¶</a></h2>
<p>To model the stems, we it a vector to each stem.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">stems</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">tree_id</span><span class="p">:</span> <span class="n">vector</span><span class="o">.</span><span class="n">Vector</span><span class="o">.</span><span class="n">from_coords</span><span class="p">(</span><span class="n">las</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tree_id</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">cluster_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>

</pre></div>
</div>
</div>
<p>Finally, we determinate the tree root coordinates of the stems by calculating the intersection points with the surface.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">roots</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">tree_id</span><span class="p">:</span> <span class="n">vector</span><span class="o">.</span><span class="n">vector_surface_intersection</span><span class="p">(</span><span class="n">stem</span><span class="p">,</span> <span class="n">dem</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tree_id</span><span class="p">,</span> <span class="n">stem</span> <span class="ow">in</span> <span class="n">stems</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>
<span class="n">origins</span> <span class="o">=</span> <span class="p">{</span> <span class="n">tree_id</span><span class="p">:</span> <span class="n">stem</span><span class="o">.</span><span class="n">origin</span> <span class="k">for</span> <span class="n">tree_id</span><span class="p">,</span> <span class="n">stem</span> <span class="ow">in</span> <span class="n">stems</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">axes_lims</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axes_lims</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y (m)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Z (m)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">las</span><span class="p">[</span><span class="n">las</span><span class="o">.</span><span class="n">tree_id</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">las</span><span class="o">.</span><span class="n">tree_id</span><span class="p">[</span><span class="n">las</span><span class="o">.</span><span class="n">tree_id</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Set1&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">roots</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">origins</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Set1&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tree_id</span> <span class="ow">in</span> <span class="n">roots</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">roots</span><span class="p">[</span><span class="n">tree_id</span><span class="p">],</span> <span class="n">origins</span><span class="p">[</span><span class="n">tree_id</span><span class="p">]])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">coords</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_stem_detection_49_0.png" src="../_images/tutorials_stem_detection_49_0.png" />
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo_pyoints.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Detection of tree stems with Pyoints</a><ul>
<li><a class="reference internal" href="#Loading-of-the-point-cloud-data">Loading of the point cloud data</a></li>
<li><a class="reference internal" href="#Calculation-of-the-height-above-ground">Calculation of the height above ground</a></li>
<li><a class="reference internal" href="#Filtering-of-stem-points">Filtering of stem points</a></li>
<li><a class="reference internal" href="#Identification-of-stem-clusters">Identification of stem clusters</a></li>
<li><a class="reference internal" href="#Fitting-of-stem-vectors">Fitting of stem vectors</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="getting_started.html"
                        title="previous chapter">Getting started</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="icp.html"
                        title="next chapter">ICP for point cloud alignment</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/tutorials/stem_detection.ipynb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="icp.html" title="ICP for point cloud alignment"
             >next</a> |</li>
        <li class="right" >
          <a href="getting_started.html" title="Getting started"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Pyoints version 0.2.0rc1 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Sebastian Lamprecht.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.4.
    </div>
  </body>
</html>